version: '3.8'

services:
  postgres:
    image: postgres:16-alpine
    container_name: muditor-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${DATABASE_NAME:-muditor}
      POSTGRES_USER: ${DATABASE_USER:-muditor}
      POSTGRES_PASSWORD: ${DATABASE_PASSWORD}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - ./postgres-data:/var/lib/postgresql/data
    ports:
      - '${POSTGRES_PORT:-5432}:5432'
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${DATABASE_USER:-muditor}']
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - muditor-network

  redis:
    image: redis:7-alpine
    container_name: muditor-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}
    volumes:
      - ./redis-data:/data
    ports:
      - '${REDIS_PORT:-6379}:6379'
    healthcheck:
      test: ['CMD', 'redis-cli', '--raw', 'incr', 'ping']
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - muditor-network

  api:
    image: node:20-alpine
    container_name: muditor-api
    restart: unless-stopped
    working_dir: /app
    environment:
      NODE_ENV: development
      DATABASE_URL: postgresql://${DATABASE_USER:-muditor}:${DATABASE_PASSWORD}@postgres:5432/${DATABASE_NAME:-muditor}
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379
      JWT_SECRET: ${JWT_SECRET}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET}
      PORT: 4000
      API_HOST: 0.0.0.0
    volumes:
      - ./muditor:/app
      - /app/node_modules
      - /app/apps/api/node_modules
      - /app/apps/web/node_modules
    ports:
      - '${API_PORT:-4000}:4000'
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    command: >
      sh -c "
        apk add --no-cache python3 make g++ &&
        npm install -g pnpm &&
        pnpm install --frozen-lockfile &&
        pnpm db:generate &&
        pnpm --filter @muditor/db build &&
        pnpm --filter @muditor/api dev
      "
    networks:
      - muditor-network

  web:
    image: node:20-alpine
    container_name: muditor-web
    restart: unless-stopped
    working_dir: /app
    environment:
      NODE_ENV: development
      NEXT_PUBLIC_GRAPHQL_URL: ${NEXT_PUBLIC_GRAPHQL_URL:-http://localhost:4000/graphql}
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-https://api.muditor.utaboshi.com}
      PORT: 3000
    volumes:
      - ./muditor:/app
      - /app/node_modules
      - /app/apps/api/node_modules
      - /app/apps/web/node_modules
    ports:
      - '${WEB_PORT:-3002}:3000'
    depends_on:
      - api
    command: >
      sh -c "
        apk add --no-cache python3 make g++ &&
        npm install -g pnpm &&
        pnpm install --frozen-lockfile &&
        pnpm --filter @muditor/web dev
      "
    networks:
      - muditor-network

networks:
  muditor-network:
    driver: bridge

volumes:
  postgres-data:
  redis-data:
