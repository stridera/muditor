generator client {
  provider = "prisma-client-js"
}

generator py {
  provider             = "prisma-client-py"
  interface            = "asyncio"
  recursive_type_depth = "-1"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ABILITY SYSTEM (NEW)
// ============================================================================

model Ability {
  id             Int      @id @default(autoincrement())
  name           String   // Display name with color codes (XML-Lite format)
  plainName      String   @unique @map("plain_name") // Plain text name - unique identifier
  description    String?
  abilityType    String   @default("SPELL") // Type: SPELL, SKILL, SONG, CHANT
  schoolId       Int?     @map("school_id")
  minPosition    Position @default(STANDING)
  violent        Boolean  @default(false)
  castTimeRounds Int      @default(1) @map("cast_time_rounds")
  cooldownMs     Int      @default(0) @map("cooldown_ms")
  inCombatOnly   Boolean  @default(false) @map("in_combat_only")
  combatOk       Boolean  @default(true) @map("combat_ok") // Can be used during combat
  isArea         Boolean  @default(false) @map("is_area")
  isToggle       Boolean  @default(false) @map("is_toggle") // Toggle ability (on/off state)
  notes          String?
  tags           String[] @default([])
  luaScript      String?  @map("lua_script") @db.Text

  // --- Spell metadata ---
  sphere          SpellSphere? // Spell sphere: fire, water, healing, etc.
  damageType      ElementType? @map("damage_type") // Primary damage type for display
  pages           Int?         // Spellbook pages required to scribe
  memorizationTime Int         @default(0) @map("memorization_time") // Additional memorization rounds
  questOnly       Boolean      @default(false) @map("quest_only") // Quest-restricted ability
  humanoidOnly    Boolean      @default(false) @map("humanoid_only") // Only available to humanoids

  // --- Stealth & Visibility ---
  contestedVisibility Boolean     @default(false) @map("contested_visibility") // Room messages require perception checks
  visibilityCheck     String?     @map("visibility_check") // Check formula: "stealth vs perception"

  // --- Relationships ---
  effects            AbilityEffect[]
  school             AbilitySchool?       @relation(fields: [schoolId], references: [id])
  characterAbilities CharacterAbilities[]
  mobAbilities       MobAbilities[]
  classAbilities     ClassAbilities[]
  classSkills        ClassSkills[]
  components         AbilityComponent[]
  damageComponents   AbilityDamageComponent[]  // Multi-element damage (e.g., Fireball = FIRE + FORCE)
  messages           AbilityMessages?
  restrictions       AbilityRestrictions?
  savingThrows       AbilitySavingThrow[]
  targeting          AbilityTargeting?
  raceAbilities      RaceAbilities[]
  objectAbilities    ObjectAbilities[]
  commands           Command[]          // Commands that trigger this ability

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
}

model ToolboxCategory {
  id           Int      @id @default(autoincrement())
  name         String   @unique // Display name: "Damage & Healing"
  colour       String   // Hex color: "#e53935"
  displayOrder Int      @map("display_order")
  effects      Effect[]

  @@map("ToolboxCategory")
}

model Effect {
  id            Int              @id @default(autoincrement())
  name          String           @unique
  description   String?
  effectType    String           // e.g., "damage", "heal", "status", "crowd_control"
  tags          String[]         // e.g., ["damage", "elemental", "fire"] for filtering
  defaultParams Json             @default("{}") @map("default_params")
  paramSchema   Json?            @map("param_schema") // JSON Schema for validation
  categoryId    Int?             @map("category_id")
  category      ToolboxCategory? @relation(fields: [categoryId], references: [id])
  abilities     AbilityEffect[]

  @@index([effectType])
  @@index([categoryId])
}

model AbilityEffect {
  abilityId      Int     @map("ability_id")
  ability        Ability @relation(fields: [abilityId], references: [id], onDelete: Cascade)
  effectId       Int     @map("effect_id")
  effect         Effect  @relation(fields: [effectId], references: [id], onDelete: Cascade)
  overrideParams Json?   @map("override_params")
  order          Int     @default(0)
  trigger        String? // e.g., "on_cast", "on_hit", "on_tick"
  chancePct      Int     @default(100) @map("chance_pct")
  condition      String? // Lua expression: "target.isUndead"

  @@id([abilityId, effectId, order])
}

model AbilitySchool {
  id          Int       @id @default(autoincrement())
  name        String    @unique
  description String?
  abilities   Ability[]
}

model AbilityRestrictions {
  id        Int     @id @default(autoincrement())
  abilityId Int     @unique @map("ability_id")
  ability   Ability @relation(fields: [abilityId], references: [id], onDelete: Cascade)

  requirements         Json[]  @default([])
  customRequirementLua String? @map("custom_requirement_lua")
}

model AbilitySavingThrow {
  id           Int      @id @default(autoincrement())
  abilityId    Int      @map("ability_id")
  ability      Ability  @relation(fields: [abilityId], references: [id], onDelete: Cascade)
  saveType     SaveType @default(SPELL)
  dcFormula    String   @map("dc_formula")
  onSaveAction Json     @default("\"NEGATE\"") @map("on_save_action")
}

model AbilityTargeting {
  id           Int          @id @default(autoincrement())
  abilityId    Int          @unique @map("ability_id")
  ability      Ability      @relation(fields: [abilityId], references: [id], onDelete: Cascade)
  validTargets TargetType[] @default([SELF]) @map("valid_targets")
  scope        TargetScope  @default(SINGLE)
  scopePattern String?      @map("scope_pattern")
  maxTargets   Int          @default(1) @map("max_targets")
  range        Int          @default(0)
  requireLos   Boolean      @default(false) @map("require_los")
}

model AbilityMessages {
  id              Int     @id @default(autoincrement())
  abilityId       Int     @unique @map("ability_id")
  startToCaster   String? @map("start_to_caster")
  startToVictim   String? @map("start_to_victim")
  startToRoom     String? @map("start_to_room")
  successToCaster String? @map("success_to_caster")
  successToVictim String? @map("success_to_victim")
  successToRoom   String? @map("success_to_room")
  successToSelf   String? @map("success_to_self")     // Message to caster when casting on self
  successSelfRoom String? @map("success_self_room")   // Room message when caster targets self
  failToCaster    String? @map("fail_to_caster")
  failToVictim    String? @map("fail_to_victim")
  failToRoom      String? @map("fail_to_room")
  wearoffToTarget String? @map("wearoff_to_target")
  wearoffToRoom   String? @map("wearoff_to_room")
  lookMessage     String? @map("look_message")        // Message shown when looking at someone with this effect
  ability         Ability @relation(fields: [abilityId], references: [id], onDelete: Cascade)
}

model AbilityComponent {
  id        Int     @id @default(autoincrement())
  abilityId Int     @map("ability_id")
  objectId  Int     @map("object_id")
  consumed  Boolean @default(false)
  required  Boolean @default(true)
  ability   Ability @relation(fields: [abilityId], references: [id], onDelete: Cascade)
}

// Multi-component damage for abilities (e.g., Fireball = 70% FIRE + 30% FORCE)
model AbilityDamageComponent {
  id            Int         @id @default(autoincrement())
  abilityId     Int         @map("ability_id")
  element       ElementType
  damageFormula String      @map("damage_formula") // e.g., "8d6", "2d6+level"
  percentage    Int         @default(100)          // % of total damage (should sum to 100)
  sequence      Int         @default(0)            // order of application

  ability       Ability     @relation(fields: [abilityId], references: [id], onDelete: Cascade)

  @@index([abilityId])
}

model ObjectAbilities {
  id           Int     @id @default(autoincrement())
  abilityId    Int     @map("ability_id")
  level        Int     @default(1)
  objectZoneId Int     @map("object_zone_id")
  objectId     Int     @map("object_id")
  charges      Int?
  objects      Objects @relation(fields: [objectZoneId, objectId], references: [zoneId, id], onDelete: Cascade)
  ability      Ability @relation(fields: [abilityId], references: [id], onDelete: Cascade)

  @@unique([objectZoneId, objectId, abilityId])
}

model ClassAbilityCircles {
  id             Int            @id @default(autoincrement())
  classId        Int            @map("class_id")
  circle         Int
  minLevel       Int            @map("min_level")
  characterClass CharacterClass @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@unique([classId, circle])
}

model ClassAbilities {
  id             Int            @id @default(autoincrement())
  classId        Int            @map("class_id")
  abilityId      Int            @map("ability_id")
  circle         Int
  characterClass CharacterClass @relation(fields: [classId], references: [id], onDelete: Cascade)
  ability        Ability        @relation(fields: [abilityId], references: [id], onDelete: Cascade)

  @@unique([classId, abilityId])
}

model ClassSkills {
  id             Int            @id @default(autoincrement())
  classId        Int            @map("class_id")
  abilityId      Int            @map("ability_id")
  minLevel       Int            @map("min_level")
  characterClass CharacterClass @relation(fields: [classId], references: [id], onDelete: Cascade)
  ability        Ability        @relation(fields: [abilityId], references: [id], onDelete: Cascade)

  @@unique([classId, abilityId])
}

model CharacterAbilities {
  id          Int        @id @default(autoincrement())
  characterId String     @map("character_id")
  abilityId   Int        @map("ability_id")
  known       Boolean    @default(false)
  proficiency Int        @default(0)
  lastUsed    DateTime?  @map("last_used")
  character   Characters @relation(fields: [characterId], references: [id], onDelete: Cascade)
  ability     Ability    @relation(fields: [abilityId], references: [id], onDelete: Cascade)

  @@unique([characterId, abilityId])
}

model MobAbilities {
  id        Int     @id @default(autoincrement())
  mobZoneId Int     @map("mob_zone_id")
  mobId     Int     @map("mob_id")
  abilityId Int     @map("ability_id")
  circle    Int     @default(1)
  known     Boolean @default(true)
  mob       Mobs    @relation(fields: [mobZoneId, mobId], references: [zoneId, id], onDelete: Cascade)
  ability   Ability @relation(fields: [abilityId], references: [id], onDelete: Cascade)

  @@unique([mobZoneId, mobId, abilityId])
}

// ============================================================================
// EXISTING MODELS
// ============================================================================

model CharacterClass {
  id                  Int                   @id @default(autoincrement())
  name                String                // Display name with color codes (XML-Lite format)
  plainName           String                @unique @map("plain_name") // Plain text name - unique identifier
  description         String?
  hitDice             String                @default("1d8") @map("hit_dice")
  primaryStat         String?               @map("primary_stat")

  // Combat modifiers - class-based bonuses
  bonusHitroll        Int                   @default(0) @map("bonus_hitroll")
  bonusDamroll        Int                   @default(0) @map("bonus_damroll")
  baseAc              Int                   @default(100) @map("base_ac") // Base armor class (100 = standard)
  hpPerLevel          Int                   @default(10) @map("hp_per_level")
  thac0Base           Int                   @default(20) @map("thac0_base") // THAC0 at level 1
  thac0PerLevel       Float                 @default(1.0) @map("thac0_per_level") // THAC0 improvement per level

  // Elemental resistances: JSON object { "FIRE": 25, "MENTAL": -25 }
  // Values: -100 (2x damage) to 100 (immune). Stacks multiplicatively with race/gear.
  resistances         Json?                 @default("{}")

  createdAt           DateTime              @default(now()) @map("created_at")
  updatedAt           DateTime              @updatedAt @map("updated_at")
  characters          Characters[]
  classSkills         ClassSkills[]
  classAbilities      ClassAbilities[]
  classAbilityCircles ClassAbilityCircles[]
  mobs                Mobs[]

  @@map("Class")
}

// ============================================================================
// HELP SYSTEM
// ============================================================================

model HelpEntry {
  id          Int      @id @default(autoincrement())
  keywords    String[] // Multiple keywords for lookup (e.g., ["FIREBALL", "FIRE BALL"])
  title       String   // Primary display title
  content     String   @db.Text // Full help text content
  minLevel    Int      @default(0) @map("min_level") // 0 = all players, 100+ = immortal only
  category    String?  // Optional category for organization (e.g., "spell", "skill", "command")

  // Parsed metadata (for spell/skill entries)
  usage       String?  // Usage syntax
  duration    String?  // Duration description
  sphere      String?  // Spell sphere (fire, water, healing, etc.)
  classes     Json?    // Class/circle requirements as JSON (e.g., {"Pyromancer": 7, "Sorcerer": 3})

  // Tracking
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  sourceFile  String?  @map("source_file") // Original help file this came from

  @@index([keywords], type: Gin)
  @@map("HelpEntry")
}

model AuditLogs {
  id         String   @id
  action     String
  entityType String   @map("entity_type")
  entityId   String   @map("entity_id")
  oldValues  Json?    @map("old_values")
  newValues  Json?    @map("new_values")
  userId     String   @map("user_id")
  createdAt  DateTime @default(now()) @map("created_at")
  users      Users    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model BanRecords {
  id           String    @id
  userId       String    @map("user_id")
  bannedBy     String    @map("banned_by")
  reason       String
  bannedAt     DateTime  @default(now()) @map("banned_at")
  expiresAt    DateTime? @map("expires_at")
  unbannedAt   DateTime? @map("unbanned_at")
  unbannedBy   String?   @map("unbanned_by")
  active       Boolean   @default(true)
  bannedByUser Users     @relation("bannedByUser", fields: [bannedBy], references: [id])
  user         Users     @relation("userBanRecords", fields: [userId], references: [id], onDelete: Cascade)

  @@index([active])
  @@index([bannedAt])
  @@index([bannedBy])
  @@index([userId])
}

model ChangeLogs {
  id          Int      @id @default(autoincrement())
  entityType  String   @map("entity_type")
  entityId    String   @map("entity_id")
  action      String
  changes     Json     @default("{}")
  userId      String   @map("user_id")
  timestamp   DateTime @default(now())
  description String?
  users       Users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([entityType, entityId])
  @@index([timestamp])
  @@index([userId, timestamp])
}

model CharacterEffects {
  id           Int        @id @default(autoincrement())
  characterId  String     @map("character_id")
  effectName   String     @map("effect_name")
  effectType   String?    @map("effect_type")
  duration     Int?
  strength     Int        @default(1)
  modifierData Json       @default("{}") @map("modifier_data")
  sourceType   String?    @map("source_type")
  sourceId     Int?       @map("source_id")
  appliedAt    DateTime   @default(now()) @map("applied_at")
  expiresAt    DateTime?  @map("expires_at")
  characters   Characters @relation(fields: [characterId], references: [id], onDelete: Cascade)
}

model CharacterItems {
  id                       Int              @id @default(autoincrement())
  characterId              String           @map("character_id")
  objectZoneId             Int              @map("object_zone_id")
  objectId                 Int              @map("object_id")
  containerId              Int?             @map("container_id")
  equippedLocation         String?          @map("equipped_location")
  condition                Int              @default(100)
  charges                  Int              @default(-1)
  instanceFlags            String[]         @default([]) @map("instance_flags")
  customName               String?          @map("custom_name")
  customExamineDescription String?          @map("custom_examine_description")
  customValues             Json             @default("{}") @map("custom_values")
  createdAt                DateTime         @default(now()) @map("created_at")
  updatedAt                DateTime         @map("updated_at")
  characters               Characters       @relation(fields: [characterId], references: [id], onDelete: Cascade)
  container                CharacterItems?  @relation("itemContainer", fields: [containerId], references: [id])
  containedItems           CharacterItems[] @relation("itemContainer")
  objects                  Objects          @relation(fields: [objectZoneId, objectId], references: [zoneId, id], onDelete: Cascade)
}

model Characters {
  id                 String               @id
  name               String               @unique
  level              Int                  @default(1)
  alignment          Int                  @default(0)
  strength           Int                  @default(13)
  intelligence       Int                  @default(13)
  wisdom             Int                  @default(13)
  dexterity          Int                  @default(13)
  constitution       Int                  @default(13)
  charisma           Int                  @default(13)
  luck               Int                  @default(13)
  hitPoints          Int                  @default(100) @map("hit_points")
  movement           Int                  @default(100)
  hitPointsMax       Int                  @default(100) @map("hit_points_max")
  movementMax        Int                  @default(100) @map("movement_max")
  wealth             BigInt               @default(0) // Stored in copper units
  bankWealth         BigInt               @default(0) @map("bank_wealth") // Bank balance in copper
  averageStats       Int                  @default(13) @map("average_stats")
  passwordHash       String               @default("") @map("password_hash")
  raceType           String               @default("human") @map("race_type")
  race               Race                 @default(HUMAN)
  gender             String               @default("neutral")
  playerClass        String?              @map("player_class")
  height             Int?
  weight             Int?
  baseHeight         Int?                 @map("base_height")
  baseWeight         Int?                 @map("base_weight")
  baseSize           Int                  @default(0) @map("base_size")
  currentSize        Int                  @default(0) @map("current_size")
  hitRoll            Int                  @default(0) @map("hit_roll")
  damageRoll         Int                  @default(0) @map("damage_roll")
  armorClass         Int                  @default(10) @map("armor_class")
  currentRoomZoneId  Int?                 @map("current_room_zone_id")
  currentRoomId      Int?                 @map("current_room_id")
  saveRoomZoneId     Int?                 @map("save_room_zone_id")
  saveRoomId         Int?                 @map("save_room_id")
  homeRoomZoneId     Int?                 @map("home_room_zone_id")
  homeRoomId         Int?                 @map("home_room_id")
  lastLogin          DateTime?            @map("last_login")
  timePlayed         Int                  @default(0) @map("time_played")
  isOnline           Boolean              @default(false) @map("is_online")
  hunger             Int                  @default(0)
  thirst             Int                  @default(0)
  description        String?
  title              String?
  prompt             String               @default("<%%h/%%Hhp %%v/%%Vmv>")
  pageLength         Int                  @default(25) @map("page_length")
  playerFlags        String[]             @default([]) @map("player_flags")
  effectFlags        String[]             @default([]) @map("effect_flags")
  privilegeFlags     String[]             @default([]) @map("privilege_flags")
  olcZones           Int[]                @default([]) @map("olc_zones")
  invisLevel         Int                  @default(0) @map("invis_level")
  wimpyThreshold     Int                  @default(0) @map("wimpy_threshold")
  freezeLevel        Int?                 @map("freeze_level")
  autoInvisLevel     Int                  @default(0) @map("auto_invis_level")
  birthTime          DateTime             @default(now()) @map("birth_time")
  userId             String?              @map("user_id")
  createdAt          DateTime             @default(now()) @map("created_at")
  updatedAt          DateTime             @updatedAt @map("updated_at")
  // Soft delete support
  deletedAt          DateTime?            @map("deleted_at")
  deletionReason     String?              @map("deletion_reason")
  classId            Int?                 @map("class_id")
  experience         Int                  @default(0)
  skillPoints        Int                  @default(0) @map("skill_points")
  characterAliases   CharacterAliases[]
  characterEffects   CharacterEffects[]
  characterItems     CharacterItems[]
  characterAbilities CharacterAbilities[]
  characterPets      CharacterPets[]
  characterClass     CharacterClass?      @relation(fields: [classId], references: [id])
  users              Users?               @relation(fields: [userId], references: [id], onDelete: SetNull)
  accountItemsStored      AccountItems[]       // Items this character deposited to account storage
  mailSent                PlayerMail[]         @relation("mailSent")
  mailReceived            PlayerMail[]         @relation("mailReceived")
  mailWealthRetrievedBy   PlayerMail[]         @relation("mailWealthRetrievedBy")
  mailObjectRetrievedBy   PlayerMail[]         @relation("mailObjectRetrievedBy")
}

model CharacterAliases {
  id          Int        @id @default(autoincrement())
  characterId String     @map("character_id")
  alias       String
  command     String
  characters  Characters @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@unique([characterId, alias])
}

model CharacterPets {
  id                   String     @id @default(uuid())
  characterId          String     @map("character_id")
  mobPrototypeZoneId   Int        @map("mob_prototype_zone_id")
  mobPrototypeVnum     Int        @map("mob_prototype_vnum")
  name                 String     // Pet's current name (can be customized)
  customDescription    String?    @map("custom_description") @db.Text
  createdAt            DateTime   @default(now()) @map("created_at")

  // Relationships
  character            Characters @relation(fields: [characterId], references: [id], onDelete: Cascade)
  mobPrototype         Mobs       @relation(fields: [mobPrototypeZoneId, mobPrototypeVnum], references: [zoneId, id], onDelete: Cascade)

  @@index([characterId])
  @@index([mobPrototypeZoneId, mobPrototypeVnum])
}

model EquipmentSetItems {
  id             Int           @id @default(autoincrement())
  equipmentSetId Int           @map("equipment_set_id")
  objectZoneId   Int           @map("object_zone_id")
  objectId       Int           @map("object_id")
  slot           String?
  quantity       Int           @default(1)
  probability    Float         @default(1.0)
  equipment_sets EquipmentSets @relation(fields: [equipmentSetId], references: [id], onDelete: Cascade)
  objects        Objects       @relation(fields: [objectZoneId, objectId], references: [zoneId, id], onDelete: Cascade)
}

model EquipmentSets {
  id                Int                 @id @default(autoincrement())
  name              String
  description       String?
  createdAt         DateTime            @default(now()) @map("created_at")
  updatedAt         DateTime            @updatedAt @map("updated_at")
  equipmentSetItems EquipmentSetItems[]
  mobEquipmentSets  MobEquipmentSets[]
}

model MobCarrying {
  id           Int       @id @default(autoincrement())
  max          Int       @default(1)
  name         String?
  objectZoneId Int       @map("object_zone_id")
  objectId     Int       @map("object_id")
  resetId      Int       @map("reset_id")
  objects      Objects   @relation(fields: [objectZoneId, objectId], references: [zoneId, id], onDelete: Cascade)
  mob_resets   MobResets @relation(fields: [resetId], references: [id], onDelete: Cascade)
}

model MobEquipmentSets {
  id             Int           @id @default(autoincrement())
  mobResetId     Int           @map("mob_reset_id")
  equipmentSetId Int           @map("equipment_set_id")
  probability    Float         @default(1.0)
  equipment_sets EquipmentSets @relation(fields: [equipmentSetId], references: [id], onDelete: Cascade)
  mob_resets     MobResets     @relation(fields: [mobResetId], references: [id], onDelete: Cascade)

  @@unique([mobResetId, equipmentSetId])
}

model MobResetEquipment {
  id           Int       @id @default(autoincrement())
  maxInstances Int       @default(1) @map("max_instances")
  wearLocation String?   @map("wear_location")
  objectZoneId Int       @map("object_zone_id")
  objectId     Int       @map("object_id")
  resetId      Int       @map("reset_id")
  probability  Float     @default(1.0)
  objects      Objects   @relation(fields: [objectZoneId, objectId], references: [zoneId, id], onDelete: Cascade)
  mob_resets   MobResets @relation(fields: [resetId], references: [id], onDelete: Cascade)
}

model MobResets {
  id                Int                 @id @default(autoincrement())
  maxInstances      Int                 @default(1) @map("max_instances")
  comment           String?
  mobZoneId         Int                 @map("mob_zone_id")
  mobId             Int                 @map("mob_id")
  roomZoneId        Int                 @map("room_zone_id")
  roomId            Int                 @map("room_id")
  zoneId            Int                 @map("zone_id")
  probability       Float               @default(1.0)
  resetBehavior     String              @default("PERSISTENT") @map("reset_behavior")
  mobCarrying       MobCarrying[]
  mobEquipmentSets  MobEquipmentSets[]
  mobResetEquipment MobResetEquipment[]
  mobs              Mobs                @relation(fields: [mobZoneId, mobId], references: [zoneId, id], onDelete: Cascade)
  rooms             Room               @relation(fields: [roomZoneId, roomId], references: [zoneId, id], onDelete: Cascade)
  zones             Zones               @relation(fields: [zoneId], references: [id], onDelete: Cascade)
  spawnConditions   SpawnConditions[]
}

model Mobs {
  id                 Int
  keywords           String[]
  name               String          @map("name")
  plainName          String          @default("") @map("plain_name")
  roomDescription    String          @map("room_description")
  plainRoomDescription String        @default("") @map("plain_room_description")
  examineDescription String          @map("examine_description")
  plainExamineDescription String     @default("") @map("plain_examine_description")
  alignment          Int             @default(0)
  level              Int             @default(1)

  // MOB ROLE CLASSIFICATION
  role                      MobRole         @default(TRASH)

  // LEGACY COMBAT STATS (to be removed after migration)
  armorClass                Int             @default(0) @map("armor_class")
  hitRoll                   Int             @default(0) @map("hit_roll")

  // NEW OFFENSIVE STATS
  accuracy                  Int             @default(0)
  attackPower               Int             @default(0) @map("attack_power")
  spellPower                Int             @default(0) @map("spell_power")
  penetrationFlat           Int             @default(0) @map("penetration_flat")
  penetrationPercent        Int             @default(0) @map("penetration_percent")

  // NEW DEFENSIVE STATS
  evasion                   Int             @default(0)
  armorRating               Int             @default(0) @map("armor_rating")
  damageReductionPercent    Int             @default(0) @map("damage_reduction_percent")
  soak                      Int             @default(0)
  hardness                  Int             @default(0)
  wardPercent               Int             @default(0) @map("ward_percent")

  // ELEMENTAL RESISTANCES
  // JSON object { "FIRE": 25, "COLD": -50, "HOLY": 100 }
  // Values: -100 (2x damage) to 100 (immune), >100 for absorption (explicit only)
  resistances               Json            @default("{}")

  move               Int             @default(0)
  hpDiceNum          Int             @default(0) @map("hp_dice_num")
  hpDiceSize         Int             @default(0) @map("hp_dice_size")
  hpDiceBonus        Int             @default(0) @map("hp_dice_bonus")
  damageDiceNum      Int             @default(0) @map("damage_dice_num")
  damageDiceSize     Int             @default(0) @map("damage_dice_size")
  damageDiceBonus    Int             @default(0) @map("damage_dice_bonus")
  wealth             BigInt          @default(0) // Stored in copper units
  raceAlign          Int             @default(0) @map("race_align")
  averageStats       Int             @default(13) @map("average_stats")
  estimatedHp        Int             @default(0) @map("estimated_hp")
  strength           Int             @default(13)
  intelligence       Int             @default(13)
  wisdom             Int             @default(13)
  dexterity          Int             @default(13)
  constitution       Int             @default(13)
  charisma           Int             @default(13)
  perception         Int             @default(0)
  concealment        Int             @default(0)
  zoneId             Int             @map("zone_id")
  createdAt          DateTime        @default(now()) @map("created_at")
  updatedAt          DateTime        @updatedAt @map("updated_at")
  deletedAt          DateTime?       @map("deleted_at")
  createdBy          String?         @map("created_by")
  updatedBy          String?         @map("updated_by")
  classId            Int?            @map("class_id")
  race               Race            @default(HUMANOID)
  mobFlags           MobFlag[]
  effectFlags        EffectFlag[]
  position           Position        @default(STANDING)
  defaultPosition    Position        @default(STANDING)
  gender             Gender          @default(NEUTRAL)
  size               Size            @default(MEDIUM)
  lifeForce          LifeForce       @default(LIFE)
  composition        Composition     @default(FLESH)
  stance             Stance          @default(ALERT)
  damageType         DamageType      @default(HIT)
  mobResets          MobResets[]
  mobAbilities       MobAbilities[]
  characterPets      CharacterPets[]
  characterClass     CharacterClass? @relation(fields: [classId], references: [id])
  zones              Zones           @relation(fields: [zoneId], references: [id], onDelete: Cascade)
  shops              Shops[]
  triggers           Triggers[]      // Legacy direct FK (deprecated)
  mobTriggers        MobTriggers[]   // Proper many-to-many via junction table
  shopMobs           ShopMobs[]      // Mobs for sale at pet/mount shops

  @@id([zoneId, id])
  @@index([name])
  @@index([zoneId, name])
  @@index([plainName])
  @@index([plainRoomDescription])
  @@index([plainExamineDescription])
}

model ObjectAffects {
  id           Int     @id @default(autoincrement())
  location     String
  modifier     Int
  objectZoneId Int     @map("object_zone_id")
  objectId     Int     @map("object_id")
  objects      Objects @relation(fields: [objectZoneId, objectId], references: [zoneId, id], onDelete: Cascade)
}

model ObjectExtraDescriptions {
  id           Int      @id @default(autoincrement())
  keywords     String[]
  description  String
  objectZoneId Int      @map("object_zone_id")
  objectId     Int      @map("object_id")
  objects      Objects  @relation(fields: [objectZoneId, objectId], references: [zoneId, id], onDelete: Cascade)
}

// Resistance bonuses granted by equipment (e.g., Ring of Fire Resistance)
model ObjectResistance {
  id              Int         @id @default(autoincrement())
  objectZoneId    Int         @map("object_zone_id")
  objectId        Int         @map("object_id")
  element         ElementType
  value           Int         // -100 to 100 normally, >100 for absorption items
  allowAbsorption Boolean     @default(false) @map("allow_absorption") // Can exceed 100%?

  object          Objects     @relation(fields: [objectZoneId, objectId], references: [zoneId, id], onDelete: Cascade)

  @@unique([objectZoneId, objectId, element])
}

// ObjectResets: Root objects that spawn directly in rooms
// Nested objects (inside containers) are defined in ObjectResetContents
model ObjectResets {
  id              Int                   @id @default(autoincrement())
  maxInstances    Int                   @default(1) @map("max_instances")
  comment         String?
  objectZoneId    Int                   @map("object_zone_id")
  objectId        Int                   @map("object_id")
  roomZoneId      Int                   @map("room_zone_id")
  roomId          Int                   @map("room_id")
  zoneId          Int                   @map("zone_id")
  probability     Float                 @default(1.0)
  resetBehavior   String                @default("PERSISTENT") @map("reset_behavior")
  objects         Objects               @relation(fields: [objectZoneId, objectId], references: [zoneId, id], onDelete: Cascade)
  rooms           Room                  @relation(fields: [roomZoneId, roomId], references: [zoneId, id], onDelete: Cascade)
  zones           Zones                 @relation(fields: [zoneId], references: [id], onDelete: Cascade)
  spawnConditions SpawnConditions[]
  contents        ObjectResetContents[] // Objects that spawn inside this container
}

// ObjectResetContents: Objects that spawn inside a container (nested arbitrarily deep)
model ObjectResetContents {
  id              Int                   @id @default(autoincrement())
  resetId         Int                   @map("reset_id")
  parentContentId Int?                  @map("parent_content_id") // NULL = direct child of reset's object
  objectZoneId    Int                   @map("object_zone_id")
  objectId        Int                   @map("object_id")
  quantity        Int                   @default(1)
  comment         String?

  reset           ObjectResets          @relation(fields: [resetId], references: [id], onDelete: Cascade)
  parentContent   ObjectResetContents?  @relation("contentNesting", fields: [parentContentId], references: [id], onDelete: Cascade)
  childContents   ObjectResetContents[] @relation("contentNesting")
  objects         Objects               @relation(fields: [objectZoneId, objectId], references: [zoneId, id], onDelete: Cascade)
}

model Objects {
  id                      Int
  type                    ObjectType                @default(NOTHING)
  keywords                String[]
  name                    String                    @map("name")
  plainName               String                    @default("") @map("plain_name")
  roomDescription         String                    @map("room_description")
  plainRoomDescription    String                    @default("") @map("plain_room_description")
  examineDescription      String?                   @map("examine_description")
  plainExamineDescription String?                   @default("") @map("plain_examine_description")
  actionDescription       String?                   @map("action_desc")
  plainActionDescription  String?                   @default("") @map("plain_action_desc")
  weight                  Float                     @default(0.0)
  cost                    Int                       @default(0)
  timer                   Int                       @default(0)
  decomposeTimer          Int                       @default(0) @map("decompose_timer")
  level                   Int                       @default(1)
  concealment             Int                       @default(0)
  values                  Json                      @default("{}")
  zoneId                  Int                       @map("zone_id")
  createdAt               DateTime                  @default(now()) @map("created_at")
  updatedAt               DateTime                  @updatedAt @map("updated_at")
  deletedAt               DateTime?                 @map("deleted_at")
  createdBy               String?                   @map("created_by")
  updatedBy               String?                   @map("updated_by")
  flags                   ObjectFlag[]
  effectFlags             EffectFlag[]
  wearFlags               WearFlag[]
  characterItems          CharacterItems[]
  equipmentSetItems       EquipmentSetItems[]
  mobCarrying             MobCarrying[]
  mobResetEquipment       MobResetEquipment[]
  objectAffects           ObjectAffects[]
  objectExtraDescriptions ObjectExtraDescriptions[]
  objectResets            ObjectResets[]
  objectResetContents     ObjectResetContents[]
  objectResistances       ObjectResistance[]        // Resistance bonuses granted by this item
  zones                   Zones                     @relation(fields: [zoneId], references: [id], onDelete: Cascade)
  shopItems               ShopItems[]
  triggers                Triggers[]                // Legacy direct FK (deprecated)
  objectTriggers          ObjectTriggers[]          // Proper many-to-many via junction table
  objectAbilities         ObjectAbilities[]
  accountItems            AccountItems[]
  mailAttachments         PlayerMail[]              // Objects attached to mail messages

  @@id([zoneId, id])
  @@index([name])
  @@index([zoneId, name])
  @@index([plainName])
  @@index([plainRoomDescription])
  @@index([plainExamineDescription])
}

model Races {
  race               Race            @id
  name               String          // Display name with color codes (XML-Lite format)
  plainName          String          @unique @map("plain_name") // Plain text name - unique identifier
  keywords           String
  playable           Boolean         @default(false)
  humanoid           Boolean         @default(false)
  magical            Boolean         @default(false)
  raceAlign          RaceAlign       @default(GOOD) @map("race_align")
  defaultSize        Size            @default(MEDIUM) @map("default_size")
  defaultAlignment   Int             @default(0) @map("default_alignment")
  bonusDamroll       Int             @default(0) @map("bonus_damroll")
  bonusHitroll       Int             @default(0) @map("bonus_hitroll")
  focusBonus         Int             @default(100) @map("focus_bonus")
  defaultLifeforce   LifeForce       @default(LIFE) @map("default_lifeforce")
  defaultComposition Composition     @default(FLESH) @map("default_composition")
  maleWeightLow      Int             @default(0) @map("male_weight_low")
  maleWeightHigh     Int             @default(0) @map("male_weight_high")
  maleHeightLow      Int             @default(0) @map("male_height_low")
  maleHeightHigh     Int             @default(0) @map("male_height_high")
  femaleWeightLow    Int             @default(0) @map("female_weight_low")
  femaleWeightHigh   Int             @default(0) @map("female_weight_high")
  femaleHeightLow    Int             @default(0) @map("female_height_low")
  femaleHeightHigh   Int             @default(0) @map("female_height_high")
  maxStrength        Int             @default(76) @map("max_strength")
  maxDexterity       Int             @default(76) @map("max_dexterity")
  maxIntelligence    Int             @default(76) @map("max_intelligence")
  maxWisdom          Int             @default(76) @map("max_wisdom")
  maxConstitution    Int             @default(76) @map("max_constitution")
  maxCharisma        Int             @default(76) @map("max_charisma")
  expFactor          Int             @default(100) @map("exp_factor")
  hpFactor           Int             @default(100) @map("hp_factor")
  hitDamageFactor    Int             @default(100) @map("hit_damage_factor")
  damageDiceFactor   Int             @default(100) @map("damage_dice_factor")
  copperFactor       Int             @default(75) @map("copper_factor")
  acFactor           Int             @default(100) @map("ac_factor")
  enterVerb          String?         @map("enter_verb")
  leaveVerb          String?         @map("leave_verb")
  permanentEffects   EffectFlag[]    @map("permanent_effects")

  // Elemental resistances: JSON object { "FIRE": 25, "COLD": -25, "HOLY": 100 }
  // Values: -100 (2x damage) to 100 (immune). Stacks multiplicatively.
  resistances        Json?           @default("{}")

  // Race-specific starting room (e.g., evil races start in their own town)
  // Priority: saveRoom > raceRoom > classRoom > mudDefault
  startRoomZoneId    Int?            @map("start_room_zone_id")
  startRoomId        Int?            @map("start_room_id")

  createdAt          DateTime        @default(now()) @map("created_at")
  updatedAt          DateTime        @updatedAt @map("updated_at")
  raceAbilities      RaceAbilities[]
}

model RaceAbilities {
  id        Int           @id @default(autoincrement())
  race      Race
  abilityId Int           @map("ability_id")
  category  SkillCategory @default(SECONDARY)
  bonus     Int           @default(0)
  raceData  Races         @relation(fields: [race], references: [race], onDelete: Cascade)
  ability   Ability       @relation(fields: [abilityId], references: [id], onDelete: Cascade)

  @@unique([race, abilityId])
}

model RoomExit {
  id              Int        @id @default(autoincrement())
  direction       Direction
  description     String?
  keywords        String[]   @default([])
  key             String?
  toZoneId        Int?       @map("to_zone_id")
  toRoomId        Int?       @map("to_room_id")
  roomZoneId      Int        @map("room_zone_id")
  roomId          Int        @map("room_id")
  flags           ExitFlag[] @default([])
  sourceRoom      Room      @relation("roomExits", fields: [roomZoneId, roomId], references: [zoneId, id], onDelete: Cascade)
  destinationRoom Room?     @relation("roomEntrances", fields: [toZoneId, toRoomId], references: [zoneId, id])

  @@unique([roomZoneId, roomId, direction])
}

model RoomExtraDescriptions {
  id          Int      @id @default(autoincrement())
  keywords    String[]
  description String
  roomZoneId  Int      @map("room_zone_id")
  roomId      Int      @map("room_id")
  rooms       Room    @relation(fields: [roomZoneId, roomId], references: [zoneId, id], onDelete: Cascade)
}

model Room {
  id                    Int
  name                  String
  roomDescription       String                  @map("room_description")
  plainRoomDescription  String                  @default("") @map("plain_room_description")
  sector                Sector                  @default(STRUCTURE)
  zoneId                Int                     @map("zone_id")
  createdAt             DateTime                @default(now()) @map("created_at")
  updatedAt             DateTime                @updatedAt @map("updated_at")
  deletedAt             DateTime?               @map("deleted_at")
  createdBy             String?                 @map("created_by")
  updatedBy             String?                 @map("updated_by")
  flags                 RoomFlag[]
  layoutX               Int?                    @map("layout_x")
  layoutY               Int?                    @map("layout_y")
  layoutZ               Int?                    @default(0) @map("layout_z")
  mobResets             MobResets[]
  objectResets          ObjectResets[]
  exits                 RoomExit[]             @relation("roomExits")
  entrances             RoomExit[]             @relation("roomEntrances")
  roomExtraDescriptions RoomExtraDescriptions[]
  zones                 Zones                   @relation(fields: [zoneId], references: [id], onDelete: Cascade)

  @@id([zoneId, id])
  @@index([plainRoomDescription])
}

model ShopAccepts {
  id         Int      @id @default(autoincrement())
  type       String
  keywords   String[]
  shopZoneId Int      @map("shop_zone_id")
  shopId     Int      @map("shop_id")
  shops      Shops    @relation(fields: [shopZoneId, shopId], references: [zoneId, id], onDelete: Cascade)
}

model ShopHours {
  id         Int   @id @default(autoincrement())
  open       Int
  close      Int
  shopZoneId Int   @map("shop_zone_id")
  shopId     Int   @map("shop_id")
  shops      Shops @relation(fields: [shopZoneId, shopId], references: [zoneId, id], onDelete: Cascade)
}

model ShopItems {
  id           Int     @id @default(autoincrement())
  amount       Int     @default(0)
  shopZoneId   Int     @map("shop_zone_id")
  shopId       Int     @map("shop_id")
  objectZoneId Int     @map("object_zone_id")
  objectId     Int     @map("object_id")

  // Spawn and availability controls
  spawnChance           Float   @default(1.0) @map("spawn_chance") // 0.0-1.0 probability
  visibilityRequirement String? @map("visibility_requirement") // Lua expr: when shown in list
  purchaseRequirement   String? @map("purchase_requirement") // Lua expr: when can buy

  objects      Objects @relation(fields: [objectZoneId, objectId], references: [zoneId, id], onDelete: Cascade)
  shops        Shops   @relation(fields: [shopZoneId, shopId], references: [zoneId, id], onDelete: Cascade)

  @@unique([shopZoneId, shopId, objectZoneId, objectId])
}

// Mobs for sale at pet/mount shops (replaces legacy "backroom" hack)
model ShopMobs {
  id         Int   @id @default(autoincrement())
  amount     Int   @default(-1) // -1 = unlimited stock
  shopZoneId Int   @map("shop_zone_id")
  shopId     Int   @map("shop_id")
  mobZoneId  Int   @map("mob_zone_id")
  mobId      Int   @map("mob_id")

  // Spawn and availability controls
  spawnChance           Float   @default(1.0) @map("spawn_chance") // 0.0-1.0 probability
  visibilityRequirement String? @map("visibility_requirement") // Lua expr: when shown in list
  purchaseRequirement   String? @map("purchase_requirement") // Lua expr: when can buy

  mobs       Mobs  @relation(fields: [mobZoneId, mobId], references: [zoneId, id], onDelete: Cascade)
  shops      Shops @relation(fields: [shopZoneId, shopId], references: [zoneId, id], onDelete: Cascade)

  @@unique([shopZoneId, shopId, mobZoneId, mobId])
}

model ShopRooms {
  id         Int   @id @default(autoincrement())
  roomId     Int   @map("room_id")
  shopZoneId Int   @map("shop_zone_id")
  shopId     Int   @map("shop_id")
  shops      Shops @relation(fields: [shopZoneId, shopId], references: [zoneId, id], onDelete: Cascade)

  @@unique([shopZoneId, shopId, roomId])
}

model Shops {
  id                  Int
  buyProfit           Float            @default(1.0) @map("buy_profit")
  sellProfit          Float            @default(1.0) @map("sell_profit")
  temper              Int              @default(0)
  noSuchItemMessages  String[]         @default([]) @map("no_such_item_messages")
  doNotBuyMessages    String[]         @default([]) @map("do_not_buy_messages")
  missingCashMessages String[]         @default([]) @map("missing_cash_messages")
  buyMessages         String[]         @default([]) @map("buy_messages")
  sellMessages        String[]         @default([]) @map("sell_messages")
  keeperZoneId        Int?             @map("keeper_zone_id")
  keeperId            Int?             @map("keeper_id")
  zoneId              Int              @map("zone_id")
  createdAt           DateTime         @default(now()) @map("created_at")
  updatedAt           DateTime         @updatedAt @map("updated_at")
  createdBy           String?          @map("created_by")
  updatedBy           String?          @map("updated_by")
  flags               ShopFlag[]
  tradesWithFlags     ShopTradesWith[]
  shopAccepts         ShopAccepts[]
  shopHours           ShopHours[]
  shopItems           ShopItems[]
  shopMobs            ShopMobs[]
  shopRooms           ShopRooms[]
  mobs                Mobs?            @relation(fields: [keeperZoneId, keeperId], references: [zoneId, id])
  zones               Zones            @relation(fields: [zoneId], references: [id], onDelete: Cascade)

  @@id([zoneId, id])
}

model SpawnConditions {
  id            Int           @id @default(autoincrement())
  type          String
  parameters    Json          @default("{}")
  mobResetId    Int?          @map("mob_reset_id")
  objectResetId Int?          @map("object_reset_id")
  mobResets     MobResets?    @relation(fields: [mobResetId], references: [id], onDelete: Cascade)
  objectResets  ObjectResets? @relation(fields: [objectResetId], references: [id], onDelete: Cascade)
}

model Triggers {
  id           Int           @id @default(autoincrement())
  name         String
  attachType   ScriptType
  numArgs      Int           @default(0) @map("num_args")
  argList      String[]      @default([]) @map("arg_list")
  commands     String
  zoneId       Int?          @map("zone_id")
  mobZoneId    Int?          @map("mob_zone_id")
  mobId        Int?          @map("mob_id")
  objectZoneId Int?          @map("object_zone_id")
  objectId     Int?          @map("object_id")
  variables    Json          @default("{}")
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")
  createdBy    String?       @map("created_by")
  updatedBy    String?       @map("updated_by")
  flags        TriggerFlag[]

  // DG Scripts trigger vnum (e.g., 3011 = zone 30, id 11)
  // Used to map "T <vnum>" lines in mob files to database triggers
  vnum         Int?          @unique

  // Validation tracking
  needsReview  Boolean       @default(false) @map("needs_review")
  syntaxError  String?       @map("syntax_error")

  // Direct FK relations (for triggers attached to a single entity)
  mobs         Mobs?         @relation(fields: [mobZoneId, mobId], references: [zoneId, id], onDelete: Cascade)
  objects      Objects?      @relation(fields: [objectZoneId, objectId], references: [zoneId, id], onDelete: Cascade)
  zones        Zones?        @relation(fields: [zoneId], references: [id], onDelete: Cascade)

  // Many-to-many junction tables (for shared triggers)
  mobTriggers    MobTriggers[]
  objectTriggers ObjectTriggers[]
}

/// Junction table for Mob-Trigger many-to-many relationship
/// In DG Scripts, triggers are shared - a single trigger can be attached to multiple mobs
/// via "T <trigger_vnum>" lines in mob files
model MobTriggers {
  mobZoneId   Int      @map("mob_zone_id")
  mobId       Int      @map("mob_id")
  triggerId   Int      @map("trigger_id")
  createdAt   DateTime @default(now()) @map("created_at")

  mob      Mobs     @relation(fields: [mobZoneId, mobId], references: [zoneId, id], onDelete: Cascade)
  trigger  Triggers @relation(fields: [triggerId], references: [id], onDelete: Cascade)

  @@id([mobZoneId, mobId, triggerId])
  @@index([triggerId])
}

/// Junction table for Object-Trigger many-to-many relationship
model ObjectTriggers {
  objectZoneId Int      @map("object_zone_id")
  objectId     Int      @map("object_id")
  triggerId    Int      @map("trigger_id")
  createdAt    DateTime @default(now()) @map("created_at")

  object   Objects  @relation(fields: [objectZoneId, objectId], references: [zoneId, id], onDelete: Cascade)
  trigger  Triggers @relation(fields: [triggerId], references: [id], onDelete: Cascade)

  @@id([objectZoneId, objectId, triggerId])
  @@index([triggerId])
}

model Users {
  id                  String       @id
  email               String       @unique
  username            String       @unique
  passwordHash        String       @map("password_hash")
  role                UserRole     @default(PLAYER)
  createdAt           DateTime     @default(now()) @map("created_at")
  updatedAt           DateTime     @updatedAt @map("updated_at")
  lastLoginAt         DateTime?    @map("last_login_at")
  resetToken          String?      @map("reset_token")
  resetTokenExpiry    DateTime?    @map("reset_token_expiry")
  failedLoginAttempts Int          @default(0) @map("failed_login_attempts")
  lockedUntil         DateTime?    @map("locked_until")
  lastFailedLogin     DateTime?    @map("last_failed_login")
  preferences         Json?        @default("{}")
  accountWealth       BigInt       @default(0) @map("account_wealth") // Shared account bank in copper
  auditLogs           AuditLogs[]
  banRecordsIssued    BanRecords[] @relation("bannedByUser")
  banRecords          BanRecords[] @relation("userBanRecords")
  changeLogs          ChangeLogs[]
  characters          Characters[]
  grants              UserGrants[]
  grantsIssued        UserGrants[] @relation("grantsIssued")
  accountItems        AccountItems[]
  accountMailSent     AccountMail[] @relation("accountMailSent")
  accountMailReceived AccountMail[] @relation("accountMailReceived")
  discordLink         DiscordLink?
  // Soft delete support
  deletedAt           DateTime?    @map("deleted_at")
  deletionReason      String?      @map("deletion_reason")
}

model UserGrants {
  id           Int               @id @default(autoincrement())
  userId       String            @map("user_id")
  resourceType GrantResourceType @map("resource_type")
  resourceId   String            @map("resource_id")
  permissions  GrantPermission[]
  grantedBy    String            @map("granted_by")
  grantedAt    DateTime          @default(now()) @map("granted_at")
  expiresAt    DateTime?         @map("expires_at")
  notes        String?

  user          Users @relation(fields: [userId], references: [id], onDelete: Cascade)
  grantedByUser Users @relation("grantsIssued", fields: [grantedBy], references: [id])

  @@unique([userId, resourceType, resourceId])
  @@map("user_grants")
}

// Account-wide item storage (accessible by all characters on the account)
// Requires character to be linked to a user account
model AccountItems {
  id                  Int       @id @default(autoincrement())
  userId              String    @map("user_id")
  slot                Int       @default(0) // Position in storage for ordering
  objectZoneId        Int       @map("object_zone_id")
  objectId            Int       @map("object_id")
  quantity            Int       @default(1) // For stackable items
  customData          Json?     @map("custom_data") // Item modifications (enchants, etc)
  storedAt            DateTime  @default(now()) @map("stored_at")
  storedByCharacterId String?   @map("stored_by_character_id") // Which character deposited it

  user      Users       @relation(fields: [userId], references: [id], onDelete: Cascade)
  object    Objects     @relation(fields: [objectZoneId, objectId], references: [zoneId, id])
  character Characters? @relation(fields: [storedByCharacterId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@map("account_items")
}

// Global events for seasonal content, promotions, and special occasions
model Events {
  id          Int       @id @default(autoincrement())
  name        String    @unique // e.g., "christmas", "halloween", "summer_festival"
  displayName String    @map("display_name") // e.g., "Christmas Event"
  description String?

  // Scheduling (null = manual activation only)
  startDate   DateTime? @map("start_date")
  endDate     DateTime? @map("end_date")
  recurring   Boolean   @default(false) // repeats yearly?

  // Manual override
  active      Boolean   @default(false) // manual on/off toggle

  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  createdBy   String?   @map("created_by")
  updatedBy   String?   @map("updated_by")
}

model Zones {
  id           Int            @id
  name         String
  lifespan     Int            @default(30)
  resetMode    ResetMode      @default(NORMAL)
  hemisphere   Hemisphere     @default(NORTHWEST)
  climate      Climate        @default(NONE)
  createdAt    DateTime       @default(now()) @map("created_at")
  updatedAt    DateTime       @updatedAt @map("updated_at")
  deletedAt    DateTime?      @map("deleted_at")
  createdBy    String?        @map("created_by")
  updatedBy    String?        @map("updated_by")
  mobResets    MobResets[]
  mobs         Mobs[]
  objectResets ObjectResets[]
  objects      Objects[]
  rooms        Room[]
  shops        Shops[]
  triggers     Triggers[]
}

// ============================================================================
// SOCIALS (Emotes/Actions)
// ============================================================================

model Social {
  id                 Int      @id @default(autoincrement())
  name               String   @unique // Command name (e.g., "smile", "bow", "hug")
  hide               Boolean  @default(false) // Hide who initiated the action
  minVictimPosition  Position @default(STANDING) @map("min_victim_position") // Victim must be at least this position

  // No argument provided - actor alone
  charNoArg          String?  @map("char_no_arg") // Message to actor
  othersNoArg        String?  @map("others_no_arg") // Message to room

  // Argument provided, target found
  charFound          String?  @map("char_found") // Message to actor (null = no target allowed)
  othersFound        String?  @map("others_found") // Message to room (excluding target)
  victFound          String?  @map("vict_found") // Message to target

  // Argument provided, target not found
  notFound           String?  @map("not_found") // "Can't find that person"

  // Self-targeting (actor targets themselves)
  charAuto           String?  @map("char_auto") // Message to actor
  othersAuto         String?  @map("others_auto") // Message to room

  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  @@index([name])
}

// ============================================================================
// ENUMS
// ============================================================================

enum ReportType {
  BUG
  IDEA
  TYPO
}

enum ReportStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  WONT_FIX
  DUPLICATE
}

enum Climate {
  NONE
  SEMIARID
  ARID
  OCEANIC
  TEMPERATE
  SUBTROPICAL
  TROPICAL
  SUBARCTIC
  ARCTIC
  ALPINE
}

enum Composition {
  FLESH
  EARTH
  AIR
  FIRE
  WATER
  ICE
  MIST
  ETHER
  METAL
  STONE
  BONE
  LAVA
  PLANT
}

enum DamageType {
  HIT
  STING
  WHIP
  SLASH
  BITE
  BLUDGEON
  CRUSH
  POUND
  CLAW
  MAUL
  THRASH
  PIERCE
  BLAST
  PUNCH
  STAB
  FIRE
  COLD
  ACID
  SHOCK
  POISON
  ALIGN
  MENTAL
  ROT
  ENERGY
  WATER
}

enum Direction {
  NORTH
  EAST
  SOUTH
  WEST
  UP
  DOWN
  NORTHEAST
  NORTHWEST
  SOUTHEAST
  SOUTHWEST
  IN
  OUT
  PORTAL
  NONE
}

enum EffectFlag {
  BLIND
  INVISIBLE
  DETECT_ALIGN
  DETECT_INVIS
  DETECT_MAGIC
  SENSE_LIFE
  WATERWALK
  SANCTUARY
  CONFUSION
  CURSE
  INFRAVISION
  POISON
  PROTECT_EVIL
  PROTECT_GOOD
  SLEEP
  NO_TRACK
  TAMED
  BERSERK
  SNEAK
  STEALTH
  FLY
  CHARM
  STONE_SKIN
  FARSEE
  HASTE
  BLUR
  VITALITY
  GLORY
  MAJOR_PARALYSIS
  FAMILIARITY
  MESMERIZED
  IMMOBILIZED
  LIGHT
  UNUSED
  MINOR_PARALYSIS
  HURT_THROAT
  FEATHER_FALL
  WATERBREATH
  SOULSHIELD
  SILENCE
  PROTECT_FIRE
  PROTECT_COLD
  PROTECT_AIR
  PROTECT_EARTH
  FIRESHIELD
  COLDSHIELD
  MINOR_GLOBE
  MAJOR_GLOBE
  HARNESS
  ON_FIRE
  FEAR
  TONGUES
  DISEASE
  INSANITY
  ULTRAVISION
  NEGATE_HEAT
  NEGATE_COLD
  NEGATE_AIR
  NEGATE_EARTH
  REMOTE_AGGRO
  AWARE
  REDUCE
  ENLARGE
  VAMPIRIC_TOUCH
  RAY_OF_ENFEEBLEMENT
  ANIMATED
  EXPOSED
  SHADOWING
  CAMOUFLAGED
  SPIRIT_WOLF
  SPIRIT_BEAR
  WRATH
  MISDIRECTION
  MISDIRECTING
  BLESS
  HEX
  DETECT_POISON
  SONG_OF_REST
  DISPLACEMENT
  GREATER_DISPLACEMENT
  FIRE_WEAPON
  ICE_WEAPON
  POISON_WEAPON
  ACID_WEAPON
  SHOCK_WEAPON
  RADIANT_WEAPON
}

enum ExitFlag {
  IS_DOOR
  CLOSED
  LOCKED
  PICKPROOF
  HIDDEN
}

enum Gender {
  NEUTRAL
  MALE
  FEMALE
  NON_BINARY
}

enum MobRole {
  TRASH
  NORMAL
  ELITE
  MINIBOSS
  BOSS
  RAID_BOSS
}

enum Hemisphere {
  NORTHWEST
  NORTHEAST
  SOUTHWEST
  SOUTHEAST
}

enum LifeForce {
  LIFE
  UNDEAD
  MAGIC
  CELESTIAL
  DEMONIC
  ELEMENTAL
}

enum MobFlag {
  SPEC
  SENTINEL
  SCAVENGER
  IS_NPC
  AWARE
  AGGRESSIVE
  STAY_ZONE
  WIMPY
  AGGRO_EVIL
  AGGRO_GOOD
  AGGRO_NEUTRAL
  MEMORY
  HELPER
  NO_CHARM
  NO_SUMMON
  NO_SLEEP
  NO_BASH
  NO_BLIND
  MOUNT
  STAY_SECT
  HATES_SUN
  NO_KILL
  TRACK
  ILLUSION
  POISON_BITE
  THIEF
  WARRIOR
  SORCERER
  CLERIC
  PALADIN
  ANTI_PALADIN
  RANGER
  DRUID
  SHAMAN
  ASSASSIN
  MERCENARY
  NECROMANCER
  CONJURER
  MONK
  BERSERKER
  DIABOLIST
  SLOW_TRACK
  NO_SILENCE
  PEACEFUL
  PROTECTOR
  PEACEKEEPER
  HASTE
  BLUR
  TEACHER
  MOUNTABLE
  NO_VICIOUS
  NO_CLASS_AI
  FAST_TRACK
  AQUATIC
  NO_EQ_RESTRICT
  SUMMONED_MOUNT
  NO_POISON
  BANKER
  RECEPTIONIST
  POSTMASTER
  SHOPKEEPER
}

enum ObjectFlag {
  GLOW
  HUM
  TEMPORARY
  ANTI_BERSERKER
  NO_INVISIBLE
  INVISIBLE
  MAGIC
  NO_DROP
  PERMANENT
  ANTI_GOOD
  ANTI_EVIL
  ANTI_NEUTRAL
  ANTI_SORCERER
  ANTI_CLERIC
  ANTI_ROGUE
  ANTI_WARRIOR
  NO_SELL
  ANTI_PALADIN
  ANTI_ANTI_PALADIN
  ANTI_RANGER
  ANTI_DRUID
  ANTI_SHAMAN
  ANTI_ASSASSIN
  ANTI_MERCENARY
  ANTI_NECROMANCER
  ANTI_CONJURER
  NO_BURN
  NO_LOCATE
  DECOMPOSING
  FLOAT
  NO_FALL
  WAS_DISARMED
  ANTI_MONK
  ANTI_BARD
  ELVEN
  DWARVEN
  ANTI_THIEF
  ANTI_PYROMANCER
  ANTI_CRYOMANCER
  ANTI_ILLUSIONIST
  ANTI_PRIEST
  ANTI_DIABOLIST
  ANTI_TINY
  ANTI_SMALL
  ANTI_MEDIUM
  ANTI_LARGE
  ANTI_HUGE
  ANTI_GIANT
  ANTI_GARGANTUAN
  ANTI_COLOSSAL
  ANTI_TITANIC
  ANTI_MOUNTAINOUS
  ANTI_ARBOREAN
}

enum ObjectType {
  NOTHING
  LIGHT
  SCROLL
  WAND
  STAFF
  WEAPON
  FIREWEAPON
  MISSILE
  TREASURE
  ARMOR
  POTION
  WORN
  OTHER
  TRASH
  TRAP
  CONTAINER
  NOTE
  DRINKCONTAINER
  KEY
  FOOD
  MONEY
  PEN
  BOAT
  FOUNTAIN
  PORTAL
  ROPE
  SPELLBOOK
  WALL
  TOUCHSTONE
  BOARD
  INSTRUMENT
}

enum Position {
  DEAD
  GHOST
  MORTALLY_WOUNDED
  INCAPACITATED
  STUNNED
  SLEEPING
  RESTING
  SITTING
  KNEELING
  PRONE
  FIGHTING
  STANDING
  FLYING
}

enum Race {
  HUMAN
  ELF
  GNOME
  DWARF
  TROLL
  DROW
  DUERGAR
  OGRE
  ORC
  HALF_ELF
  BARBARIAN
  HALFLING
  PLANT
  HUMANOID
  ANIMAL
  DRAGON_GENERAL
  GIANT
  OTHER
  GOBLIN
  DEMON
  BROWNIE
  DRAGON_FIRE
  DRAGON_FROST
  DRAGON_ACID
  DRAGON_LIGHTNING
  DRAGON_GAS
  DRAGONBORN_FIRE
  DRAGONBORN_FROST
  DRAGONBORN_ACID
  DRAGONBORN_LIGHTNING
  DRAGONBORN_GAS
  SVERFNEBLIN
  FAERIE_SEELIE
  FAERIE_UNSEELIE
  NYMPH
  ARBOREAN
}

enum RaceAlign {
  UNKNOWN
  GOOD
  EVIL
}

enum ResetMode {
  NEVER
  EMPTY
  NORMAL
}

enum RoomFlag {
  DARK
  DEATH
  NO_MOB
  INDOORS
  PEACEFUL
  SOUNDPROOF
  NO_TRACK
  NO_MAGIC
  TUNNEL
  PRIVATE
  GODROOM
  HOUSE
  HOUSECRASH
  ATRIUM
  OLC
  BFS_MARK
  WORLDMAP
  FERRY_DEST
  ISOLATED
  ARENA
  LARGE
  MEDIUM_LARGE
  MEDIUM
  MEDIUM_SMALL
  SMALL
  VERY_SMALL
  ONE_PERSON
  EFFECTS_NEXT
  ALWAYS_LIT
  GUILDHALL
  NO_WELL
  NO_SUMMON
  NO_SCAN
  UNDERDARK
  NO_SHIFT
  NO_RECALL
  ALT_EXIT
  OBSERVATORY
  INN              // Rentable room - player checks out on return
  TEMPLE           // Holy place - player rises from meditation on return
  CAMPSITE         // Designated camping area - easier rest
}

enum SaveResult {
  NONE
  HALF
  NEGATE
  REDUCE25
  CUSTOM
}

enum SaveType {
  SPELL
  POISON
  BREATH
  PARALYSIS
  WAND
  ROD
  PETRIFICATION
}

enum ApplyType {
  AC
  HITROLL
  DAMROLL
  STR
  DEX
  INT
  WIS
  CON
  CHA
  SAVING_PARA
  SAVING_ROD
  SAVING_PETRI
  SAVING_BREATH
  SAVING_SPELL
  HIT_REGEN
  MAX_HP
  MAX_MANA
  MAX_MOVEMENT
  PERCEPTION
  HIDDENNESS
  SIZE
  AGE
  CHAR_WEIGHT
  CHAR_HEIGHT
  FOCUS
  COMPOSITION
  LEVEL
  NONE
}

enum ScriptType {
  MOB
  OBJECT
  WORLD
}

enum Sector {
  STRUCTURE
  CITY
  FIELD
  FOREST
  HILLS
  MOUNTAIN
  SHALLOWS
  WATER
  UNDERWATER
  AIR
  ROAD
  GRASSLANDS
  CAVE
  RUINS
  SWAMP
  BEACH
  UNDERDARK
  ASTRALPLANE
  AIRPLANE
  FIREPLANE
  EARTHPLANE
  ETHEREALPLANE
  AVERNUS
}

enum ShopFlag {
  WILL_FIGHT
  USES_BANK
  WILL_BANK_MONEY
  WILL_START_FIGHT
}

enum ShopTradesWith {
  ALIGNMENT
  RACE
  CLASS
  TRADE_NOGOOD
  TRADE_NOEVIL
  TRADE_NONEUTRAL
  TRADE_NOCLERIC
  TRADE_NOTHIEF
  TRADE_NOWARRIOR
}

enum Size {
  TINY
  SMALL
  MEDIUM
  LARGE
  HUGE
  GIANT
  GARGANTUAN
  COLOSSAL
  TITANIC
  MOUNTAINOUS
}

enum SkillCategory {
  PRIMARY
  SECONDARY
  RESTRICTED
  FORBIDDEN
}

enum SkillType {
  WEAPON
  COMBAT
  MAGIC
  STEALTH
  SOCIAL
  CRAFTING
  SURVIVAL
  KNOWLEDGE
  UTILITY
}

enum StackingRule {
  REFRESH
  STACK
  IGNORE
  MAX_ONLY
}

enum Stance {
  DEAD
  MORT
  INCAPACITATED
  STUNNED
  SLEEPING
  RESTING
  ALERT
  FIGHTING
}

enum TargetScope {
  SINGLE
  ROOM
  GROUP
  AREA
  CHAIN
  CONE
  LINE
  SELF
}

enum TargetType {
  SELF
  ALLY_PC
  ALLY_NPC
  ALLY_GROUP
  ENEMY_PC
  ENEMY_NPC
  OBJECT_INV
  OBJECT_WORLD
  CORPSE
}

enum SpellSphere {
  GENERIC
  FIRE
  WATER
  EARTH
  AIR
  HEALING
  PROTECTION
  ENCHANTMENT
  SUMMONING
  DEATH
  DIVINATION
}

enum ElementType {
  // Physical damage types
  PHYSICAL    // Generic weapon damage (fallback)
  SLASH       // Slashing weapons (swords, axes)
  PIERCE      // Piercing weapons (daggers, spears, arrows)
  CRUSH       // Crushing weapons (maces, hammers, fists)
  FORCE       // Magical kinetic energy, hits ethereal
  SONIC       // Sound/thunder, ignores physical armor
  BLEED       // Physical DoT, bypasses some armor

  // Classical elements
  FIRE        // Heat, burning (opposes COLD)
  COLD        // Freezing, slowing (opposes FIRE)
  WATER       // Drowning, pressure, conducts SHOCK
  EARTH       // Crushing, grounding (opposes AIR)
  AIR         // Suffocation, cutting winds (opposes EARTH)
  SHOCK       // Electricity, chains in water
  ACID        // Corrosion, DoT
  POISON      // Toxins, CON-based resist

  // Light/Dark
  RADIANT     // Pure light energy (opposes SHADOW)
  SHADOW      // Darkness/void (opposes RADIANT)

  // Divine
  HOLY        // Divine positive (opposes UNHOLY)
  UNHOLY      // Divine negative (opposes HOLY)

  // Life/Death
  HEAL        // Restoration, inverts on undead (opposes NECROTIC)
  NECROTIC    // Life drain, withering (opposes HEAL)

  // Other
  MENTAL      // Psychic/psionic, ignores armor
  NATURE      // Druidic/primal energy
}

enum TriggerFlag {
  // Common flags (all types)
  GLOBAL
  RANDOM
  COMMAND
  LOAD
  CAST
  LEAVE
  TIME

  // MOB-specific flags
  SPEECH
  ACT
  DEATH
  GREET
  GREET_ALL
  ENTRY
  RECEIVE
  FIGHT
  HIT_PERCENT
  BRIBE
  MEMORY
  DOOR
  SPEECH_TO
  LOOK
  AUTO  // Legacy, may be unused

  // OBJECT-specific flags
  ATTACK    // Weapon triggers on attack
  DEFEND    // Weapon triggers on defense
  TIMER     // Item timer expires
  GET       // Item picked up
  DROP      // Character tries to drop
  GIVE      // Character tries to give
  WEAR      // Character tries to wear
  REMOVE    // Character tries to remove
  USE       // Object is used
  CONSUME   // Character eats/drinks object

  // WORLD-specific flags
  RESET      // Zone has been reset
  PREENTRY   // Someone about to enter room
  POSTENTRY  // Someone just entered room
}

enum UserRole {
  PLAYER
  IMMORTAL
  BUILDER
  HEAD_BUILDER
  CODER
  GOD
}

enum GrantResourceType {
  ZONE
  MOB
  OBJECT
  SHOP
}

enum GrantPermission {
  READ
  WRITE
  DELETE
  ADMIN
}

enum WearFlag {
  TAKE
  FINGER
  NECK
  BODY
  HEAD
  LEGS
  FEET
  HANDS
  ARMS
  SHIELD
  ABOUT
  WAIST
  WRIST
  WIELD
  HOLD
  TWO_HAND_WIELD
  EYES
  FACE
  EAR
  BADGE
  BELT
  HOVER
}

// ============================================================================
// PLAYER MAIL SYSTEM
// ============================================================================

// Stores in-game mail messages between players
// Character-to-character mail (retrieved via in-game postmaster)
model PlayerMail {
  id                   Int       @id @default(autoincrement())

  // Legacy IDs for import (numeric player IDs from CircleMUD)
  // These are used during import and will be remapped to character IDs after character migration
  legacySenderId       Int?      @map("legacy_sender_id")
  legacyRecipientId    Int?      @map("legacy_recipient_id")

  // Character relationships (null = legacy mail not yet linked, or deleted sender)
  senderCharacterId    String?   @map("sender_character_id")
  recipientCharacterId String?   @map("recipient_character_id")

  // Mail content
  body                 String    @db.Text

  // Timestamps
  sentAt               DateTime  @map("sent_at")
  readAt               DateTime? @map("read_at")

  // Wealth attachments (stored in individual coin types)
  attachedCopper       Int       @default(0) @map("attached_copper")
  attachedSilver       Int       @default(0) @map("attached_silver")
  attachedGold         Int       @default(0) @map("attached_gold")
  attachedPlatinum     Int       @default(0) @map("attached_platinum")

  // Object attachment (optional) - uses composite key
  attachedObjectZoneId Int?      @map("attached_object_zone_id")
  attachedObjectId     Int?      @map("attached_object_id")

  // Retrieval tracking (for postmaster)
  wealthRetrievedAt              DateTime? @map("wealth_retrieved_at")
  wealthRetrievedByCharacterId   String?   @map("wealth_retrieved_by_character_id")
  objectRetrievedAt              DateTime? @map("object_retrieved_at")
  objectRetrievedByCharacterId   String?   @map("object_retrieved_by_character_id")
  objectMovedToAccountStorage    Boolean   @default(false) @map("object_moved_to_account_storage")

  // Status
  isDeleted            Boolean   @default(false) @map("is_deleted")

  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  // Relationships
  sender                     Characters? @relation("mailSent", fields: [senderCharacterId], references: [id], onDelete: SetNull)
  recipient                  Characters? @relation("mailReceived", fields: [recipientCharacterId], references: [id], onDelete: Cascade)
  attachedObject             Objects?    @relation(fields: [attachedObjectZoneId, attachedObjectId], references: [zoneId, id], onDelete: SetNull)
  wealthRetrievedByCharacter Characters? @relation("mailWealthRetrievedBy", fields: [wealthRetrievedByCharacterId], references: [id], onDelete: SetNull)
  objectRetrievedByCharacter Characters? @relation("mailObjectRetrievedBy", fields: [objectRetrievedByCharacterId], references: [id], onDelete: SetNull)

  @@index([senderCharacterId])
  @@index([recipientCharacterId])
  @@index([legacySenderId])
  @@index([legacyRecipientId])
  @@index([sentAt])
  @@map("PlayerMail")
}

// Account-to-account mail (viewable by any character on the account)
model AccountMail {
  id              Int       @id @default(autoincrement())

  // Account relationships
  senderUserId    String    @map("sender_user_id")
  recipientUserId String?   @map("recipient_user_id")  // null for broadcast

  // Broadcast flag
  isBroadcast     Boolean   @default(false) @map("is_broadcast")

  // Mail content
  subject         String
  body            String    @db.Text

  // Timestamps
  sentAt          DateTime  @default(now()) @map("sent_at")
  readAt          DateTime? @map("read_at")

  // Status
  isDeleted       Boolean   @default(false) @map("is_deleted")

  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relationships
  sender          Users     @relation("accountMailSent", fields: [senderUserId], references: [id], onDelete: Cascade)
  recipient       Users?    @relation("accountMailReceived", fields: [recipientUserId], references: [id], onDelete: Cascade)

  @@index([senderUserId])
  @@index([recipientUserId])
  @@index([isBroadcast])
  @@index([sentAt])
  @@map("AccountMail")
}

// ============================================================================
// GAME CONFIGURATION SYSTEM
// ============================================================================

// Server configuration - key/value store with categories
// All game settings loaded from here at startup
model GameConfig {
  id          Int      @id @default(autoincrement())
  category    String   // "server", "combat", "progression", "security", "timing", "character", "display"
  key         String   // "port", "max_connections", etc.
  value       String   // JSON-encoded value
  valueType   ConfigValueType @default(STRING) @map("value_type")
  description String?  // Admin help text
  minValue    String?  @map("min_value") // Validation bounds (JSON)
  maxValue    String?  @map("max_value")
  isSecret    Boolean  @default(false) @map("is_secret") // Hide from non-admins
  restartReq  Boolean  @default(false) @map("restart_req") // Requires server restart

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@unique([category, key])
  @@index([category])
  @@map("GameConfig")
}

// Player level definitions - XP requirements, stat gains, immortal status
model LevelDefinition {
  level        Int      @id
  name         String?  // Optional name: "Immortal", "Avatar", "God"
  expRequired  Int      @default(0) @map("exp_required") // XP to reach this level
  hpGain       Int      @default(10) @map("hp_gain") // HP gained at this level
  staminaGain  Int      @default(5) @map("stamina_gain") // Stamina gained at this level
  isImmortal   Boolean  @default(false) @map("is_immortal")
  permissions  String[] @default([]) // Permission flags granted at this level (see Command.permissions)

  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("LevelDefinition")
}

// Command definitions - synced from C++ on startup
// Defines what permissions each command requires
model Command {
  name          String          @id // Primary command name: "shutdown", "goto", "ban"
  aliases       String[]        @default([]) // Alternative names: ["teleport"] for goto
  category      CommandCategory @default(SYSTEM)
  description   String?         // Brief help text
  usage         String?         // Syntax: "shutdown [delay]"
  immortalOnly  Boolean         @default(false) @map("immortal_only") // Requires isImmortal level
  permissions   String[]        @default([]) // Required permission flags: ["shutdown"]

  // Optional link to ability for skill/spell/chant/song commands
  // If set, executing this command triggers the linked ability's effects
  abilityId     Int?            @map("ability_id")
  ability       Ability?        @relation(fields: [abilityId], references: [id], onDelete: SetNull)

  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")

  @@index([category])
  @@index([abilityId])
  @@map("Command")
}

enum CommandCategory {
  MOVEMENT        // north, south, goto
  COMBAT          // kill, flee, bash
  COMMUNICATION   // say, tell, gossip
  OBJECT          // get, drop, wear
  INFORMATION     // look, score, who
  SOCIAL          // smile, nod, wave
  ADMIN           // shutdown, ban, force
  BUILDING        // redit, oedit, zedit
  SYSTEM          // save, quit, password
  CLAN            // clan commands
  MAGIC           // cast, memorize
  SKILLS          // practice, train
}

// System text content (MOTD, screens, messages)
// Core screens loaded by the MUD at runtime
model SystemText {
  id          Int      @id @default(autoincrement())
  key         String   @unique // "motd", "welcome_screen", "imotd", "news", "credits"
  category    SystemTextCategory @default(SYSTEM)
  title       String?  // Display title
  content     String   @db.Text // Full text content (supports color codes)
  minLevel    Int      @default(0) @map("min_level") // Visibility level requirement
  isActive    Boolean  @default(true) @map("is_active")

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([category])
  @@map("SystemText")
}

// Player toggle definitions (brief, autoloot, etc.)
// Defines available toggle options - players store their values in character flags
model PlayerToggle {
  id           Int      @id @default(autoincrement())
  name         String   @unique // Internal name: "brief", "autoloot", "autogold"
  displayName  String   @map("display_name") // UI name: "Brief Mode"
  description  String   // Help text: "Show brief room descriptions"
  defaultValue Boolean  @default(false) @map("default_value")
  minLevel     Int      @default(0) @map("min_level") // 0 = all, 100+ = immortal
  category     ToggleCategory @default(DISPLAY)
  sortOrder    Int      @default(0) @map("sort_order")

  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@index([category])
  @@map("PlayerToggle")
}

enum ToggleCategory {
  DISPLAY   // brief, compact, autoexit
  COMBAT    // autoloot, autogold, autosplit
  SOCIAL    // deaf, notell, afk
  IMMORTAL  // holylight, showids, roomflags
}

// Login/character creation messages
// Allows customization of all login flow text
model LoginMessage {
  id          Int      @id @default(autoincrement())
  stage       LoginStage // Enum for type safety
  variant     String   @default("default") // For A/B testing or themes
  message     String   @db.Text
  isActive    Boolean  @default(true) @map("is_active")

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@unique([stage, variant])
  @@map("LoginMessage")
}

// ============================================================================
// CONFIGURATION ENUMS
// ============================================================================

enum ConfigValueType {
  STRING
  INT
  FLOAT
  BOOL
  JSON
}

enum SystemTextCategory {
  LOGIN      // MOTD, welcome screens
  SYSTEM     // Credits, policies, background
  COMBAT     // Death messages, victory messages
  IMMORTAL   // Immortal-only content
}

enum LoginStage {
  WELCOME_BANNER       // Initial connection banner
  USERNAME_PROMPT      // "Enter username:"
  PASSWORD_PROMPT      // "Password:"
  INVALID_LOGIN        // Login failed message
  TOO_MANY_ATTEMPTS    // Lockout message
  CHARACTER_SELECT     // Character selection prompt
  CREATE_NAME_PROMPT   // "Enter character name:"
  CREATE_PASSWORD      // "Choose password:"
  CONFIRM_PASSWORD     // "Confirm password:"
  SELECT_CLASS         // Class selection prompt
  SELECT_RACE          // Race selection prompt
  CREATION_COMPLETE    // Character created message
  RECONNECT_MESSAGE    // Reconnecting to existing session
}

// ============================================================================
// BULLETIN BOARD SYSTEM
// ============================================================================
// Boards are linked to ITEM_BOARD objects via values.value0 = board.id
// Players interact with boards through board objects placed in rooms

model Board {
  id         Int      @id @default(autoincrement())
  alias      String   @unique // Filename without extension: "mortal", "god", "quest"
  title      String   // Display title: "Mortal Board", "God Board"
  locked     Boolean  @default(false) // Moderator lock - blocks all posts/edits

  // Privilege rules for 8 access types (stored as JSON for flexibility)
  // 0=READ, 1=WRITE_NEW, 2=REMOVE_OWN, 3=EDIT_OWN, 4=REMOVE_ANY, 5=EDIT_ANY, 6=WRITE_STICKY, 7=LOCK
  privileges Json     @default("[]") // Array of privilege rule objects

  messages   BoardMessage[]

  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@map("Board")
}

model BoardMessage {
  id          Int      @id @default(autoincrement())
  boardId     Int      @map("board_id")
  board       Board    @relation(fields: [boardId], references: [id], onDelete: Cascade)

  poster      String   // Character name who posted (string for legacy compat)
  posterLevel Int      @map("poster_level") // Poster's level at time of posting
  postedAt    DateTime @map("posted_at") // When message was posted (from legacy: time)
  subject     String   // Message subject line
  content     String   @db.Text // Message body with color codes
  sticky      Boolean  @default(false) // Sticky messages float to top

  edits       BoardMessageEdit[]

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([boardId])
  @@index([poster])
  @@index([postedAt])
  @@map("BoardMessage")
}

model BoardMessageEdit {
  id         Int          @id @default(autoincrement())
  messageId  Int          @map("message_id")
  message    BoardMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)

  editor     String       // Character name who edited
  editedAt   DateTime     @map("edited_at")

  @@index([messageId])
  @@map("BoardMessageEdit")
}

// ============================================================================
// DISCORD INTEGRATION
// ============================================================================

// Links Discord accounts to Muditor user accounts
model DiscordLink {
  id          String   @id @default(uuid())
  userId      String   @unique @map("user_id")
  discordId   String   @unique @map("discord_id")
  discordName String   @map("discord_name")
  linkedAt    DateTime @default(now()) @map("linked_at")
  verified    Boolean  @default(false)

  user        Users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("discord_links")
}

// Discord bot configuration for the guild
model DiscordConfig {
  id              Int     @id @default(1)
  guildId         String  @map("guild_id")
  gossipChannelId String? @map("gossip_channel_id")
  adminChannelId  String? @map("admin_channel_id")
  announcementChannelId String? @map("announcement_channel_id")
  enabled         Boolean @default(true)

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@map("discord_config")
}

// ============================================================================
// PLAYER REPORTS (Bug, Idea, Typo)
// ============================================================================

model Report {
  id           Int          @id @default(autoincrement())
  reportType   ReportType   @map("report_type")
  status       ReportStatus @default(OPEN)

  // Reporter info
  reporterName String       @map("reporter_name") // Character name
  reporterId   String?      @map("reporter_id")   // User ID if available

  // Location context
  roomZoneId   Int?         @map("room_zone_id")
  roomId       Int?         @map("room_id")

  // Report content
  message      String       @db.Text

  // Resolution
  resolvedBy   String?      @map("resolved_by")   // Admin who resolved
  resolvedAt   DateTime?    @map("resolved_at")
  resolution   String?      @db.Text              // Resolution notes

  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")

  @@index([reportType])
  @@index([status])
  @@index([reporterName])
  @@index([createdAt])
  @@map("reports")
}

// ============================================================================
// COMBAT MESSAGE SYSTEM
// ============================================================================

// Combat messages with array columns for variety (random selection at runtime)
// Supports weapon-type and attack-type specific messages
model CombatMessage {
  id          Int      @id @default(autoincrement())
  hitType     HitType  @map("hit_type")        // miss, glancing, hit, critical
  attackType  String?  @map("attack_type")     // slash, pierce, crush, magic, NULL = all
  weaponType  String?  @map("weapon_type")     // sword, mace, dagger, NULL = all

  // Message arrays - runtime randomly selects one
  // Placeholders: {actor}, {target}, {damage}, {weapon}
  toActor     String[] @map("to_actor")        // ["You miss {target}.", "Your swing goes wide!"]
  toTarget    String[] @map("to_target")       // ["{actor} misses you.", "{actor}'s attack goes wide."]
  toRoom      String[] @map("to_room")         // ["{actor} misses {target}.", "{actor} swings wildly."]

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@unique([hitType, attackType, weaponType])
  @@index([hitType])
  @@map("CombatMessage")
}

enum HitType {
  MISS
  GLANCING
  HIT
  CRITICAL
  DEATH       // Kill messages
  DODGE       // Target dodged
  PARRY       // Target parried
  BLOCK       // Target blocked with shield
}

// ============================================================================
// QUEST SYSTEM ENUMS
// ============================================================================

enum QuestObjectiveType {
  KILL_MOB        // Kill specific mob(s)
  COLLECT_ITEM    // Collect specific item(s)
  DELIVER_ITEM    // Give item to NPC
  VISIT_ROOM      // Visit specific room
  TALK_TO_NPC     // Talk to specific NPC
  USE_SKILL       // Use a skill/ability
  CUSTOM_LUA      // Custom Lua expression
}

enum QuestRewardType {
  EXPERIENCE      // XP reward
  ITEM            // Object reward
  GOLD            // Currency reward
  ABILITY         // Learn spell/skill
  SKILL_POINTS    // Skill points
}

enum QuestStatus {
  AVAILABLE       // Can be accepted
  IN_PROGRESS     // Currently active
  COMPLETED       // Successfully finished
  FAILED          // Failed (time expired, etc.)
  ABANDONED       // Player abandoned
}

enum DialogueMatchType {
  EXACT           // Must match exactly: "paladin"  only "paladin"
  CONTAINS        // Keyword anywhere: "paladin"  "tell me about paladin"
  STARTS_WITH     // Response begins with: "yes"  "yes please"
  ANY             // Any response continues (acknowledgments)
  KEYWORD_SET     // Any of multiple: ["yes", "yep", "sure"]
  REGEX           // Pattern match for complex cases
}

// Position-based messages (sit, stand, rest, sleep transitions)
model PositionMessage {
  id           Int      @id @default(autoincrement())
  fromPosition Position @map("from_position")
  toPosition   Position @map("to_position")
  command      String?  // "sit", "stand", "rest", etc. NULL = any transition

  toActor      String[] @map("to_actor")  // ["You sit down.", "You take a seat."]
  toRoom       String[] @map("to_room")   // ["{actor} sits down.", "{actor} takes a seat."]

  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@unique([fromPosition, toPosition, command])
  @@map("PositionMessage")
}

// System/error messages with variants
model SystemMessage {
  id          Int      @id @default(autoincrement())
  key         String   @unique  // "error_too_heavy", "error_not_here", etc.
  category    String   // "error", "combat", "magic", "movement"
  messages    String[] // ["You can't carry any more.", "That's too heavy for you."]

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([category])
  @@map("SystemMessage")
}
